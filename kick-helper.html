<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kick Chat Helper</title>
    <script src="https://cdn.jsdelivr.net/npm/kick.js@2.2.0/dist/kick.js"></script>
</head>
<body>
    <p>Kick Helper is running...</p>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const chatId = params.get('chatid');
            const channelName = params.get('channel'); // We need this for the broadcaster check

            if (!chatId || !channelName) {
                document.body.innerText = 'Error: No chat ID or channel name provided in URL.';
                return;
            }

            const connect = async () => {
                try {
                    const kick = new Kick();
                    // Connect directly using the Chat ID - this is more reliable
                    await kick.chat.connect(parseInt(chatId));
                    document.body.innerText = `Successfully connected to Kick chat for ${channelName}.`;

                    kick.chat.on('message', (message) => {
                        let userType = 'viewer'; // DomyÅ›lnie
                        const badges = message.sender.identity.badges;
                        // Check if the message sender is the channel owner
                        if (message.sender.username.toLowerCase() === channelName.toLowerCase()) {
                            userType = 'broadcaster';
                        } else if (badges.some(b => b.text === 'Moderator')) {
                            userType = 'mod';
                        } else if (badges.some(b => b.text === 'Subscriber')) {
                            userType = 'sub';
                        }

                        const payload = {
                            service: 'kick',
                            displayName: message.sender.username,
                            message: message.content,
                            userType: userType,
                            color: message.sender.identity.color || '#18db81'
                        };
                        
                        // Send data to the main widget
                        window.parent.postMessage(payload, '*');
                    });

                } catch (error) {
                    console.error('Kick connection error:', error);
                    document.body.innerText = 'Error connecting to Kick chat. See console for details.';
                }
            };

            connect();
        });
    </script>
</body>
</html>
