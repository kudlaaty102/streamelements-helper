<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kick Chat Helper</title>
    <script src="https://cdn.jsdelivr.net/npm/kick.js@2.2.0/dist/kick.js"></script>
</head>
<body>
    <p>Kick Helper is running...</p>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const channelName = params.get('channel');

            // Funkcja do wysyłania statusu do głównego widgetu
            const postStatus = (status, details = '') => {
                window.parent.postMessage({ service: 'kick_status', status, details }, '*');
            };

            if (!channelName) {
                document.body.innerText = 'Error: No channel name provided in URL.';
                postStatus('error_no_channel');
                return;
            }

            const connect = async () => {
                postStatus('connecting', channelName);
                try {
                    const kick = new Kick();
                    const channel = await kick.api.chatrooms.get(channelName);
                    if (!channel) {
                        document.body.innerText = `Error: Kick channel '${channelName}' not found.`;
                        postStatus('error_not_found', channelName);
                        return;
                    }

                    await kick.chat.connect(channel.id);
                    document.body.innerText = `Successfully connected to Kick chat for ${channelName}.`;
                    postStatus('connected', channelName);

                    kick.chat.on('message', (message) => {
                        let userType = 'viewer'; // Domyślnie
                        const badges = message.sender.identity.badges;
                        if (message.sender.username.toLowerCase() === channelName.toLowerCase()) {
                            userType = 'broadcaster';
                        } else if (badges.some(b => b.text === 'Moderator')) {
                            userType = 'mod';
                        } else if (badges.some(b => b.text === 'Subscriber')) {
                            userType = 'sub';
                        }

                        const payload = {
                            service: 'kick',
                            displayName: message.sender.username,
                            message: message.content,
                            userType: userType,
                            color: message.sender.identity.color || '#18db81'
                        };
                        
                        window.parent.postMessage(payload, '*');
                    });

                } catch (error) {
                    console.error('Kick connection error:', error);
                    document.body.innerText = 'Error connecting to Kick chat. See console for details.';
                    postStatus('error_generic', error.message);
                }
            };

            connect();
        });
    </script>
</body>
</html>
